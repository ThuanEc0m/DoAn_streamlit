import streamlit as st
import pandas as pd
import cloudpickle
import os
import sqlalchemy
import requests
from streamlit_echarts import st_echarts
import matplotlib.pyplot as plt
import seaborn as sns
import ui_theme
import altair as alt
import datetime
import monitor
import streamlit.components.v1 as components
from ydata_profiling import ProfileReport
from ui_theme import render_sidebar_lottie
from shap_explainer import get_shap_explainer, explain_with_shap



# G·ªåI NGAY ƒê·∫¶U TI√äN
st.set_page_config(
    page_title="Ph√¢n t√≠ch & D·ª± ƒëo√°n Marketing",
    layout="wide",
    page_icon=":bar_chart:"
)

#model_compare------------------------------
from modules import model_compare

#--g·ªçi gif__json
render_sidebar_lottie("assets/pew.json")
# Load model
@st.cache_resource
def load_model():
    try:
        with open("model.pkl", 'rb') as f:
            return cloudpickle.load(f)
    except Exception as e:
        st.error(f"Kh√¥ng t·∫£i ƒë∆∞·ª£c model: {e}")
        return None
model = load_model()
feature_names = model.named_steps['prep'].feature_names_in_ if model else []

FIELD_DISPLAY = {
    'age': 'Tu·ªïi', 'job': 'Ngh·ªÅ nghi·ªáp', 'marital': 'H√¥n nh√¢n', 'education': 'H·ªçc v·∫•n',
    'default': 'N·ª£ x·∫•u', 'balance': 'S·ªë d∆∞ TK', 'housing': 'Vay nh√†', 'loan': 'Vay ti√™u d√πng',
    'contact': 'Li√™n h·ªá', 'day': 'Ng√†y g·ªçi', 'month': 'Th√°ng g·ªçi', 'duration': 'Th·ªùi l∆∞·ª£ng g·ªçi (s)',
    'campaign': 'S·ªë l·∫ßn g·ªçi (chi·∫øn d·ªãch)', 'pdays': 'S·ªë ng√†y t·ª´ l·∫ßn g·ªçi tr∆∞·ªõc',
    'previous': 'S·ªë l·∫ßn g·ªçi tr∆∞·ªõc', 'poutcome': 'KQ chi·∫øn d·ªãch tr∆∞·ªõc', 'deposit': 'M·ªü s·ªï ti·∫øt ki·ªám'
}
# Load ƒëa ngu·ªìn
@st.cache_data(show_spinner=False)
def load_file(file):
    if file.name.endswith(".csv"): return pd.read_csv(file)
    return pd.read_excel(file, engine="openpyxl")

@st.cache_data(show_spinner=False)
def load_mysql(host, port, user, pwd, db, table):
    uri = f"mysql+mysqlconnector://{user}:{pwd}@{host}:{port}/{db}"
    eng = sqlalchemy.create_engine(uri)
    return pd.read_sql_table(table, eng)

@st.cache_data(show_spinner=False)
def load_postgres(host, port, user, pwd, db, table):
    uri = f"postgresql+psycopg2://{user}:{pwd}@{host}:{port}/{db}"
    eng = sqlalchemy.create_engine(uri)
    return pd.read_sql_table(table, eng)

@st.cache_data(show_spinner=False)
def load_api(url):
    resp = requests.get(url, timeout=10)
    resp.raise_for_status()
    data = resp.json()
    return pd.json_normalize(data)

# Auto EDA: YData Profiling
def run_ydata_profiling(df):
    st.subheader("üìä Auto-EDA v·ªõi YData Profiling")
    profile = ProfileReport(df, title="Report", explorative=True)
    profile_html = profile.to_html()
    components.html(profile_html, height=1000, scrolling=True)
def run_sweetviz(df):
    import sweetviz as sv
    report = sv.analyze(df)
    report.show_html("sweetviz_report.html", open_browser=False)
    with open("sweetviz_report.html", 'r', encoding='utf-8') as f:
        html = f.read()
    components.html(html, height=1000, scrolling=True)

# Main App
def main():
    ui_theme.set_custom_theme()
    ui_theme.render_time_top_right()
    ui_theme.render_title_with_image("assets/data1.png", "H·ªá th·ªëng Ph√¢n t√≠ch & D·ª± ƒëo√°n m·ªü s·ªï ti·∫øt ki·ªám")


    
# Sau ƒë√≥ m·ªõi ƒë·∫øn ph·∫ßn ch·ªçn ngu·ªìn d·ªØ li·ªáu
    st.sidebar.header(" 1Ô∏è‚É£ Ch·ªçn ngu·ªìn d·ªØ li·ªáu")
    source = st.sidebar.selectbox("Data source", ["File Upload", "MySQL", "PostgreSQL", "API"])
    df = None
    if source == "File Upload":
        f = st.sidebar.file_uploader("Ch·ªçn file CSV/Excel", type=["csv", "xls", "xlsx"])
        if f: df = load_file(f)
    elif source == "MySQL":
        host = st.sidebar.text_input("MySQL host", "localhost")
        port = st.sidebar.text_input("Port", "3306")
        user = st.sidebar.text_input("User", "")
        pwd  = st.sidebar.text_input("Password", "", type="password")
        db   = st.sidebar.text_input("Database", "")
        table= st.sidebar.text_input("Table", "")
        if st.sidebar.button("Load MySQL"):
            try:
                df = load_mysql(host, port, user, pwd, db, table)
                st.sidebar.success("‚úÖ Load th√†nh c√¥ng")
            except Exception as e:
                st.sidebar.error(f"L·ªói: {e}")
    elif source == "PostgreSQL":
        host = st.sidebar.text_input("Postgres host", "localhost")
        port = st.sidebar.text_input("Port", "5432")
        user = st.sidebar.text_input("User", "")
        pwd  = st.sidebar.text_input("Password", "", type="password")
        db   = st.sidebar.text_input("Database", "")
        table= st.sidebar.text_input("Table", "")
        if st.sidebar.button("Load Postgres"):
            try:
                df = load_postgres(host, port, user, pwd, db, table)
                st.sidebar.success("‚úÖ Load th√†nh c√¥ng")
            except Exception as e:
                st.sidebar.error(f"L·ªói: {e}")
    else:
        url = st.sidebar.text_input("API URL endpoint", "")
        if st.sidebar.button("Load API"):
            try:
                df = load_api(url)
                st.sidebar.success("‚úÖ API loaded!")
            except Exception as e:
                st.sidebar.error(f"L·ªói: {e}")

        # N·∫øu d·ªØ li·ªáu ƒë√£ n·∫°p v√† c√≥ c·ªôt 'deposit' ‚Üí chia train-test
    if df is not None and 'deposit' in df.columns:
        from sklearn.model_selection import train_test_split

        df_model = df.dropna(subset=['deposit'])  # lo·∫°i b·ªè d√≤ng thi·∫øu nh√£n n·∫øu c√≥
        X = df_model.drop(columns=['deposit'])
        # Encode c√°c c·ªôt object/category
        for col in X.select_dtypes(include=['object', 'category']).columns:
            X[col] = X[col].astype('category').cat.codes
        y = df_model['deposit'].replace({'yes': 1, 'no': 0})  # chuy·ªÉn nh√£n th√†nh nh·ªã ph√¢n

        try:
            X_train, X_test, y_train, y_test = train_test_split(
                X, y, test_size=0.3, random_state=42, stratify=y
            )
            st.session_state.X_train = X_train
            st.session_state.X_test = X_test
            st.session_state.y_train = y_train
            st.session_state.y_test = y_test
        except Exception as e:
            st.warning(f"‚ö†Ô∏è Kh√¥ng th·ªÉ t√°ch train/test: {e}")
    if df is not None and not df.empty:
        st.sidebar.success(f"‚úÖ D·ªØ li·ªáu ƒë√£ n·∫°p: {df.shape[0]} d√≤ng, {df.shape[1]} c·ªôt")

    #    --- Kh·ªüi t·∫°o session n·∫øu ch∆∞a c√≥ ---
    if "current_page" not in st.session_state:
        st.session_state.current_page = "üè† Trang ch·ªß"
    # --- Callback khi ch·ªçn m·ª•c Th√¥ng tin ---
    def on_info_change():
        st.session_state.current_page = st.session_state.info_select
    # --- Callback khi ch·ªçn m·ª•c Ch·ª©c nƒÉng ---
    def on_func_change():
        st.session_state.current_page = st.session_state.func_select
    # --- 2Ô∏è‚É£ Th√¥ng tin ---
    st.sidebar.header("2Ô∏è‚É£ Th√¥ng tin")
    st.sidebar.selectbox(
        "üìò Ch·ªçn m·ª•c",
        [
            "üè† Trang ch·ªß",
            "üìå C√¢u h·ªèi nghi√™n c·ª©u",
            "üìö Ngu·ªìn d·ªØ li·ªáu & m√¥ t·∫£",
            "üìä Ph√¢n t√≠ch & k·∫øt lu·∫≠n"
        ],
        key="info_select",
        on_change=on_info_change
    )
    # --- 3Ô∏è‚É£ Ch·ª©c nƒÉng ---
    st.sidebar.header("3Ô∏è‚É£ Ch·ª©c nƒÉng")
    st.sidebar.selectbox(
        "‚öôÔ∏è Ch·ªçn ch·ª©c nƒÉng",
        [
            "üìä B√°o c√°o",
            "ü§ñ D·ª± ƒëo√°n",
            "üî¨ So s√°nh",
            "üìà Theo d√µi m√¥ h√¨nh",
            "üß© Ph√¢n t√≠ch EDA t·ª± ƒë·ªông",
            "üìà Model comparison"
        ],
        key="func_select",
        on_change=on_func_change
    )
# --- Trang hi·ªán t·∫°i l√† c√°i v·ª´a ƒë∆∞·ª£c ch·ªçn ---
    page = st.session_state.current_page

    # N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu v√† kh√¥ng ·ªü c√°c m·ª•c markdown th√¨ c·∫£nh b√°o
    if df is None and page not in [
        "üè† Trang ch·ªß", "üìå C√¢u h·ªèi nghi√™n c·ª©u", "üìö Ngu·ªìn d·ªØ li·ªáu & m√¥ t·∫£", "üìä Ph√¢n t√≠ch & k·∫øt lu·∫≠n"]:
        st.info("Ch∆∞a c√≥ d·ªØ li·ªáu, vui l√≤ng n·∫°p file.")
        return

    # 1. C√°c m·ª•c Markdown
    elif page in [
        "üè† Trang ch·ªß", "üìå C√¢u h·ªèi nghi√™n c·ª©u", "üìö Ngu·ªìn d·ªØ li·ªáu & m√¥ t·∫£", "üìä Ph√¢n t√≠ch & k·∫øt lu·∫≠n"]:
        file_map = {
            "üè† Trang ch·ªß": "vanban/trangchu.md",
            "üìå C√¢u h·ªèi nghi√™n c·ª©u": "vanban/cauhoinghiencuu.md",
            "üìö Ngu·ªìn d·ªØ li·ªáu & m√¥ t·∫£": "vanban/nguondulieuvamota.md",
            "üìä Ph√¢n t√≠ch & k·∫øt lu·∫≠n": "vanban/phantichvaketluan.md",
        }
        with open(file_map[page], "r", encoding="utf-8") as f:
            lines = f.readlines()

        section_title = None
        section_body = []
        sections = []

        for line in lines:
            if line.startswith("## "):
                if section_title:
                    sections.append((section_title, "".join(section_body)))
                section_title = line.strip("## ").strip()
                section_body = []
            else:
                section_body.append(line)
        if section_title:
            sections.append((section_title, "".join(section_body)))

        st.title(page)
        for title, content in sections:
            with st.expander(f" {title}"):
                st.markdown(content, unsafe_allow_html=True)
# 2. M·ª•c b√°o c√°o t·ªïng quan
    elif page == "üìà B√°o c√°o t·ªïng quan":
        st.markdown("### T·ªïng quan d·ªØ li·ªáu")
        total = len(df)
        if 'deposit' in df.columns:
            opened = df['deposit'].isin(['yes', 1]).sum()
            not_opened = total - opened
            ratio = (opened / total) * 100 if total > 0 else 0
            st.info(f"""
                - **T·ªïng kh√°ch:** {total}
                - **C√≥ m·ªü s·ªï:** {opened}
                - **Ch∆∞a m·ªü:** {not_opened}
                - **T·ªâ l·ªá m·ªü:** {ratio:.2f}%
            """)
        else:
            st.warning("‚õî File kh√¥ng c√≥ c·ªôt deposit ‚Äì kh√¥ng th·ªÉ ph√¢n t√≠ch t·ª∑ l·ªá m·ªü s·ªï.")
        cat_cols = df.select_dtypes(include=["object", "category"]).columns.tolist()
        num_cols = df.select_dtypes(include=["int64", "float64"]).columns.tolist()
        col1, col2 = st.columns(2, gap="large")
        with col1:
            st.markdown("#### üìå Bi·ªÉu ƒë·ªì ƒë·∫øm")
            cat_col = st.selectbox("Ch·ªçn c·ªôt ph√¢n lo·∫°i", cat_cols)
            cat_count = df[cat_col].value_counts().reset_index()
            cat_count.columns = [cat_col, 'S·ªë l∆∞·ª£ng']
            bar_chart = alt.Chart(cat_count).mark_bar().encode(
                x=alt.X(f'{cat_col}:N', sort='-y', title='Gi√° tr·ªã'),
                y=alt.Y('S·ªë l∆∞·ª£ng:Q', title='S·ªë l∆∞·ª£ng'),
                tooltip=[cat_col, 'S·ªë l∆∞·ª£ng']
            ).properties(width=380, height=300)
            st.altair_chart(bar_chart)
        with col2:
            st.markdown("#### üìå Histogram (c·ªôt s·ªë)")
            num_col = st.selectbox("Ch·ªçn c·ªôt s·ªë", num_cols)
            if num_col:
                hist_data = df[[num_col]].dropna()
                hist_chart = alt.Chart(hist_data).mark_bar().encode(
                    alt.X(f"{num_col}:Q", bin=alt.Bin(maxbins=30), title="Gi√° tr·ªã"),
                    y=alt.Y('count()', title="S·ªë l∆∞·ª£ng"),
                    tooltip=[alt.Tooltip('count()', title="S·ªë l∆∞·ª£ng")]
                ).properties(width=380, height=300)
                st.altair_chart(hist_chart)
        if 'deposit' in df.columns:
            col3, col4 = st.columns(2, gap="large")
            with col3:
                st.markdown("#### üßë‚Äçüíº T·ªâ l·ªá m·ªü s·ªï theo ngh·ªÅ")
                if 'job' in df.columns:
                    job_df = df.groupby('job')['deposit'].value_counts(normalize=True).unstack().fillna(0)*100
                    chart = alt.Chart(job_df.reset_index()).mark_bar().encode(
                        x=alt.X('yes:Q', title='T·ªâ l·ªá m·ªü (%)'),
                        y=alt.Y('job:N', sort='-x', title='Ngh·ªÅ'),
                        tooltip=['job:N', alt.Tooltip('yes:Q', format=".2f")]
                    ).properties(width=380, height=300)
                    st.altair_chart(chart)
            with col4:
                st.markdown("#### üëµ T·ªâ l·ªá m·ªü s·ªï theo ƒë·ªô tu·ªïi")
                if 'age' in df.columns:
                    age_df = df.groupby('age')['deposit'].apply(lambda x: (x == 'yes').mean() * 100).reset_index()
                    line = alt.Chart(age_df).mark_line(point=True).encode(
                        x=alt.X('age:Q', title='Tu·ªïi'),
                        y=alt.Y('deposit:Q', title='T·ªâ l·ªá m·ªü (%)'),
                        tooltip=['age', alt.Tooltip('deposit', format=".2f")]
                    ).properties(width=380, height=300)
                    st.altair_chart(line)
            col5, col6 = st.columns(2, gap="large")
            with col5:
                st.markdown("#### ü•ß Bi·ªÉu ƒë·ªì tr√≤n: T·ªâ l·ªá kh√°ch m·ªü s·ªï")
                pie_data = pd.DataFrame({
                    'label': ['C√≥ m·ªü', 'Kh√¥ng m·ªü'],
                    'value': [opened, not_opened]
                })
                pie_option = {
                    "backgroundColor": "#ffffff",
                    "tooltip": {"trigger": "item"},
                    "legend": {
                        "orient": "vertical",
                        "left": "left",
                        "textStyle": {"fontSize": 12}
                    },
                    "series": [{
                        "name": "T√¨nh tr·∫°ng",
                        "type": "pie",
                        "radius": ["30%", "90%"],
                        "center": ["50%", "50%"],
                        "data": [{"value": row['value'], "name": row['label']} for _, row in pie_data.iterrows()],
                        "label": {
                            "formatter": "{b}: {d}%",
                            "fontSize": 14
                        },
                        "emphasis": {
                            "itemStyle": {
                                "shadowBlur": 10,
                                "shadowOffsetX": 0,
                                "shadowColor": "rgba(0, 0, 0, 0.5)"
                            }
                        }
                    }]
                }
                st_echarts(pie_option, height="710px")

            with col6:
                st.markdown("#### ‚òéÔ∏è Heatmap: Th·ªùi l∆∞·ª£ng & s·ªë l·∫ßn g·ªçi")
                if 'duration' in df.columns and 'campaign' in df.columns:
                    df['duration_grp'] = pd.cut(df['duration'], bins=5)
                    df['campaign_grp'] = pd.cut(df['campaign'], bins=5)
                    heat_df = df.pivot_table(index='duration_grp', columns='campaign_grp',
                                            values='deposit', aggfunc=lambda x: (x == 'yes').mean())
                    fig, ax = plt.subplots(figsize=(5, 3))
                    sns.heatmap(heat_df, annot=True, cmap="YlGnBu", fmt=".2f", ax=ax)
                    ax.set_title("T·ªâ l·ªá m·ªü s·ªï (%)")
                    st.pyplot(fig)
#----------------------------------------
    elif page == "üìä B√°o c√°o":
        st.subheader("üìä B√°o c√°o d·ªØ li·ªáu")
        st.write(df.head())

        st.markdown("### Th·ªëng k√™ m√¥ t·∫£")
        st.write(df.describe(include="all"))
        st.markdown("### T·ªïng quan d·ªØ li·ªáu")
        total = len(df)
        if 'deposit' in df.columns:
            opened = df['deposit'].isin(['yes', 1]).sum()
            not_opened = total - opened
            ratio = (opened / total) * 100 if total > 0 else 0
            st.info(f"""
                - **T·ªïng kh√°ch:** {total}
                - **C√≥ m·ªü s·ªï:** {opened}
                - **Ch∆∞a m·ªü:** {not_opened}
                - **T·ªâ l·ªá m·ªü:** {ratio:.2f}%
            """)
        else:
            st.warning("‚õî File kh√¥ng c√≥ c·ªôt deposit ‚Äì kh√¥ng th·ªÉ ph√¢n t√≠ch t·ª∑ l·ªá m·ªü s·ªï.")

        cat_cols = df.select_dtypes(include=["object", "category"]).columns.tolist()
        num_cols = df.select_dtypes(include=["int64", "float64"]).columns.tolist()
        col1, col2 = st.columns(2, gap="large")
        with col1:
            st.markdown("#### üìå Bi·ªÉu ƒë·ªì ƒë·∫øm")
            cat_col = st.selectbox("Ch·ªçn c·ªôt ph√¢n lo·∫°i", cat_cols)
            cat_count = df[cat_col].value_counts().reset_index()
            cat_count.columns = [cat_col, 'S·ªë l∆∞·ª£ng']
            bar_chart = alt.Chart(cat_count).mark_bar().encode(
                x=alt.X(f'{cat_col}:N', sort='-y', title='Gi√° tr·ªã'),
                y=alt.Y('S·ªë l∆∞·ª£ng:Q', title='S·ªë l∆∞·ª£ng'),
                tooltip=[cat_col, 'S·ªë l∆∞·ª£ng']
            ).properties(width=380, height=300)
            st.altair_chart(bar_chart)
        with col2:
            st.markdown("#### üìå Histogram (c·ªôt s·ªë)")
            num_col = st.selectbox("Ch·ªçn c·ªôt s·ªë", num_cols)
            if num_col:
                hist_data = df[[num_col]].dropna()
                hist_chart = alt.Chart(hist_data).mark_bar().encode(
                    alt.X(f"{num_col}:Q", bin=alt.Bin(maxbins=30), title="Gi√° tr·ªã"),
                    y=alt.Y('count()', title="S·ªë l∆∞·ª£ng"),
                    tooltip=[alt.Tooltip('count()', title="S·ªë l∆∞·ª£ng")]
                ).properties(width=380, height=300)
                st.altair_chart(hist_chart)
        if 'deposit' in df.columns:
            col3, col4 = st.columns(2, gap="large")
            with col3:
                st.markdown("#### üßë‚Äçüíº T·ªâ l·ªá m·ªü s·ªï theo ngh·ªÅ")
                if 'job' in df.columns:
                    job_df = df.groupby('job')['deposit'].value_counts(normalize=True).unstack().fillna(0)*100
                    chart = alt.Chart(job_df.reset_index()).mark_bar().encode(
                        x=alt.X('yes:Q', title='T·ªâ l·ªá m·ªü (%)'),
                        y=alt.Y('job:N', sort='-x', title='Ngh·ªÅ'),
                        tooltip=['job:N', alt.Tooltip('yes:Q', format=".2f")]
                    ).properties(width=380, height=300)
                    st.altair_chart(chart)
            with col4:
                st.markdown("#### üëµ T·ªâ l·ªá m·ªü s·ªï theo ƒë·ªô tu·ªïi")
                if 'age' in df.columns:
                    age_df = df.groupby('age')['deposit'].apply(lambda x: (x == 'yes').mean() * 100).reset_index()
                    line = alt.Chart(age_df).mark_line(point=True).encode(
                        x=alt.X('age:Q', title='Tu·ªïi'),
                        y=alt.Y('deposit:Q', title='T·ªâ l·ªá m·ªü (%)'),
                        tooltip=['age', alt.Tooltip('deposit', format=".2f")]
                    ).properties(width=380, height=300)
                    st.altair_chart(line)
            col5, col6 = st.columns(2, gap="large")
            with col5:
                st.markdown("#### ü•ß Bi·ªÉu ƒë·ªì tr√≤n: T·ªâ l·ªá kh√°ch m·ªü s·ªï")
                pie_data = pd.DataFrame({
                    'label': ['C√≥ m·ªü', 'Kh√¥ng m·ªü'],
                    'value': [opened, not_opened]
                })
                pie_option = {
                    "backgroundColor": "#ffffff",
                    "tooltip": {"trigger": "item"},
                    "legend": {
                        "orient": "vertical",
                        "left": "left",
                        "textStyle": {"fontSize": 12}
                    },
                    "series": [{
                        "name": "T√¨nh tr·∫°ng",
                        "type": "pie",
                        "radius": ["30%", "90%"],
                        "center": ["50%", "50%"],
                        "data": [{"value": row['value'], "name": row['label']} for _, row in pie_data.iterrows()],
                        "label": {
                            "formatter": "{b}: {d}%",
                            "fontSize": 14
                        },
                        "emphasis": {
                            "itemStyle": {
                                "shadowBlur": 10,
                                "shadowOffsetX": 0,
                                "shadowColor": "rgba(0, 0, 0, 0.5)"
                            }
                        }
                    }]
                }
                st_echarts(pie_option, height="710px")

            with col6:
                st.markdown("#### ‚òéÔ∏è Heatmap: Th·ªùi l∆∞·ª£ng & s·ªë l·∫ßn g·ªçi")
                if 'duration' in df.columns and 'campaign' in df.columns:
                    df['duration_grp'] = pd.cut(df['duration'], bins=5)
                    df['campaign_grp'] = pd.cut(df['campaign'], bins=5)
                    heat_df = df.pivot_table(index='duration_grp', columns='campaign_grp',
                                             values='deposit', aggfunc=lambda x: (x == 'yes').mean())
                    fig, ax = plt.subplots(figsize=(5, 3))
                    sns.heatmap(heat_df, annot=True, cmap="YlGnBu", fmt=".2f", ax=ax)
                    ax.set_title("T·ªâ l·ªá m·ªü s·ªï (%)")
                    st.pyplot(fig)
#--------------------------------------------------------------------
    elif page == "ü§ñ D·ª± ƒëo√°n":
        st.subheader("ü§ñ D·ª± ƒëo√°n m·ªü s·ªï ti·∫øt ki·ªám")
        if model is None:
            st.warning("Model ch∆∞a s·∫µn s√†ng!")
        mode = st.radio("Ch·ªçn ch·∫ø ƒë·ªô", ["D·ª± ƒëo√°n t·ª´ng kh√°ch", "D·ª± ƒëo√°n nhi·ªÅu kh√°ch", "D·ª± ƒëo√°n batch"])
        # --- 1. D·ª± ƒëo√°n t·ª´ng kh√°ch ---
        if mode == "D·ª± ƒëo√°n t·ª´ng kh√°ch":
            inputs = {}
            for col in feature_names:
                display = FIELD_DISPLAY.get(col, col)
                if col in df.columns and pd.api.types.is_numeric_dtype(df[col]):
                    val = st.slider(display, float(df[col].min()), float(df[col].max()), float(df[col].median()))
                else:
                    val = st.selectbox(display, df[col].dropna().unique().tolist())
                inputs[col] = val
            if st.button("Predict"):
                X_pred = pd.DataFrame([inputs])
                y_pred = model.predict(X_pred)
                result = "‚úÖ C√≥ m·ªü s·ªï" if y_pred[0] == 1 else "‚ùå Kh√¥ng m·ªü"
                st.success(f"K·∫øt qu·∫£: {result}")
                st.write(X_pred.T.rename(columns={0: "Gi√° tr·ªã"}))
                log_entry = pd.DataFrame([{
                    "timestamp": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    **inputs,
                    "prediction": int(y_pred[0])
                }])
                log_file = "prediction_log.csv"
                if os.path.exists(log_file):
                    log_entry.to_csv(log_file, mode="a", index=False, header=False, encoding="utf-8-sig")
                else:
                    log_entry.to_csv(log_file, index=False, encoding="utf-8-sig")
# G·ªçi h√†m SHAP n·∫øu mu·ªën
                X_pred = X_pred[feature_names]  # tr∆∞·ªõc khi g·ªçi SHAP
                explainer = get_shap_explainer(model, df.sample(100, random_state=42))
                explain_with_shap(explainer ,model, X_pred)
# --- 2. D·ª± ƒëo√°n nhi·ªÅu kh√°ch ---
        elif mode == "D·ª± ƒëo√°n nhi·ªÅu kh√°ch":
            n_customers = st.slider("Ch·ªçn s·ªë kh√°ch ƒë·ªÉ d·ª± ƒëo√°n", min_value=5, max_value=100, value=10, step=5)
            randomize = st.checkbox("üîÄ Ng·∫´u nhi√™n m·ªói l·∫ßn", value=True)
            if st.button("D·ª± ƒëo√°n nh√≥m kh√°ch"):
                try:
# L·∫•y m·∫´u d·ªØ li·ªáu
                    sample_df = df.sample(n=n_customers) if randomize else df.sample(n=n_customers, random_state=42)
# L·∫•y ƒë√∫ng input cho model
                    X_input = sample_df[feature_names]
                    # --- D·ª± ƒëo√°n ---
                    if hasattr(model, "predict_proba"):
                        probs = model.predict_proba(X_input)
                        if probs.shape[1] == 2:
                            preds = (probs[:, 1] >= 0.5).astype(int)
                            sample_df["proba_open"] = probs[:, 1]
                        else:
                            preds = model.predict(X_input)
                    else:
                        preds = model.predict(X_input)
                    # G√°n k·∫øt qu·∫£ d·ª± ƒëo√°n
                    sample_df["prediction"] = preds
                    sample_df["timestamp"] = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

                    # üü¢ HI·ªÇN TH·ªä K·∫æT QU·∫¢ ·ªû ƒê√ÇY
                    st.subheader("üìã K·∫øt qu·∫£ d·ª± ƒëo√°n nh√≥m kh√°ch:")
                    st.dataframe(sample_df)

                    # --- T·∫°o danh s√°ch c·ªôt chu·∫©n ---
                    base_cols = list(feature_names)
                    if "proba_open" in sample_df.columns:
                        base_cols.append("proba_open")
                    base_cols += ["prediction", "timestamp"]

                    # --- Ghi log ---
                    sample_df[base_cols].to_csv(
                        "prediction_log.csv",
                        mode="a",
                        header=not os.path.exists("prediction_log.csv"),
                        index=False,
                        encoding="utf-8-sig"
                    )
                    st.success("‚úÖ D·ª± ƒëo√°n & log nh√≥m th√†nh c√¥ng!")
                except Exception as e:
                    st.error(f"‚ùå L·ªói khi d·ª± ƒëo√°n nh√≥m: {e}")
# --- 3. D·ª± ƒëo√°n batch ---
        elif mode == "D·ª± ƒëo√°n batch":
            file_batch = st.file_uploader("üìÅ Ch·ªçn file batch (.csv ho·∫∑c .xlsx):", type=["csv", "xlsx"])
            if file_batch:
                try:
                    if file_batch.name.endswith('.csv'):
                        df_batch = pd.read_csv(file_batch)
                    else:
                        df_batch = pd.read_excel(file_batch)

                    preds = model.predict(df_batch[feature_names])
                    df_batch["D·ª± ƒëo√°n"] = ["C√≥ m·ªü" if p == 1 else "Kh√¥ng m·ªü" for p in preds]
                    st.dataframe(df_batch)

                    csv = df_batch.to_csv(index=False).encode('utf-8-sig')
                    st.download_button("üì• T·∫£i k·∫øt qu·∫£", data=csv, file_name="ketqua_batch.csv", mime="text/csv")
                except Exception as e:
                    st.error(f"L·ªói: {e}")
        else:
            file_batch = st.file_uploader(
                "üìÅ Ch·ªçn file batch (.csv ho·∫∑c .xlsx):",
                type=["csv", "xlsx"],
                accept_multiple_files=False
            )
            if file_batch:
                try:
                    if file_batch.name.endswith('.csv'):
                        df_batch = pd.read_csv(file_batch)
                    elif file_batch.name.endswith('.xlsx'):
                        df_batch = pd.read_excel(file_batch)

                    preds = model.predict(df_batch)
                    df_batch['D·ª± ƒëo√°n'] = ["C√≥ m·ªü" if p==1 else "Kh√¥ng m·ªü" for p in preds]
                    st.dataframe(df_batch)
                    csv = df_batch.to_csv(index=False).encode('utf-8-sig')
                    st.download_button("üì• T·∫£i k·∫øt qu·∫£", data=csv, file_name="ketqua_batch.csv", mime="text/csv")
                except Exception as e:
                    st.error(f"L·ªói: {e}")
    elif page == "üî¨ So s√°nh":
        st.subheader("üî¨ So s√°nh th·ª±c t·∫ø vs d·ª± ƒëo√°n")

        file_true = st.file_uploader("Upload file th·ª±c t·∫ø (c√≥ c·ªôt deposit)", type=["csv"])
        file_pred = st.file_uploader("Upload file batch ƒë√£ d·ª± ƒëo√°n", type=["csv"])

        if file_true and file_pred:
            try:
                df_true = pd.read_csv(file_true)
                df_pred = pd.read_csv(file_pred)

                df_true['deposit'] = df_true['deposit'].replace({1: 'yes', 0: 'no'})
                df_pred['D·ª± ƒëo√°n'] = df_pred['D·ª± ƒëo√°n'].replace({'C√≥ m·ªü': 'yes', 'Kh√¥ng m·ªü': 'no'})

                compare = pd.concat([df_true.reset_index(drop=True), df_pred['D·ª± ƒëo√°n']], axis=1)
                compare['So s√°nh'] = compare.apply(lambda row: "‚úÖ" if row['deposit'] == row['D·ª± ƒëo√°n'] else "‚ùå", axis=1)
                acc = (compare['deposit'] == compare['D·ª± ƒëo√°n']).mean() * 100

                st.success(f"üéØ ƒê·ªô ch√≠nh x√°c: {acc:.2f}%")
                st.dataframe(compare)

                csv_out = compare.to_csv(index=False, encoding="utf-8-sig").encode("utf-8-sig")
                st.download_button("üì• T·∫£i k·∫øt qu·∫£ so s√°nh", data=csv_out, file_name="so_sanh.csv", mime="text/csv")

            except Exception as e:
                st.error(f"L·ªói x·ª≠ l√Ω: {e}")
    elif page == "üìà Theo d√µi m√¥ h√¨nh":
            monitor.render_log_page()
# üß© Ph√¢n t√≠ch EDA t·ª± ƒë·ªông--------------------        
    elif page == "üß© Ph√¢n t√≠ch EDA t·ª± ƒë·ªông":
        st.subheader("üß© Auto-EDA v·ªõi YData Profiling")
        if df is not None:
            eda_tool = st.selectbox("Ch·ªçn c√¥ng c·ª•", ["YData Profiling", "Sweetviz"])
            if st.button("üöÄ Ph√¢n t√≠ch d·ªØ li·ªáu"):
                if eda_tool == "YData Profiling":
                    run_ydata_profiling(df)
                else:
                    run_sweetviz(df)
        else:
            st.warning("‚õî B·∫°n c·∫ßn n·∫°p d·ªØ li·ªáu tr∆∞·ªõc ƒë·ªÉ ph√¢n t√≠ch.")

    elif page == "üìà Model comparison":
        # √âp y_train v√† y_test th√†nh int n·∫øu ƒëang ·ªü d·∫°ng float
        st.session_state.y_train = st.session_state.y_train.astype(int)
        st.session_state.y_test = st.session_state.y_test.astype(int)
        model_compare.render_comparison_page()

if __name__ == '__main__':
    main()